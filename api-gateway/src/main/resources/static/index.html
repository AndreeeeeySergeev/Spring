<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–¢–µ—Å—Ç–æ–≤—ã–π —Å—Ç–µ–Ω–¥ ‚Äî Booking/Hotel Microservices</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --fg:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --primary:#3b82f6; --warning:#f59e0b; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; background:linear-gradient(135deg,#0b1020,#0f172a 30%,#0b1020 100%); color:var(--fg); }
    header { padding:24px 16px; text-align:center; border-bottom:1px solid rgba(148,163,184,0.15); }
    .container { max-width:1400px; margin:0 auto; padding:16px; display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:16px; }
    .full { grid-column: 1 / -1; }
    .card { background:rgba(17,24,39,0.85); border:1px solid rgba(148,163,184,0.15); border-radius:14px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.04); }
    h2 { margin:0 0 12px; font-size:18px; font-weight:600; letter-spacing:0.2px; }
    h3 { margin:8px 0; font-size:14px; font-weight:500; color:var(--muted); }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    label { font-size:12px; color:var(--muted); }
    input[type="text"], input[type="password"], input[type="date"], input[type="number"] { background:#0b1220; color:var(--fg); border:1px solid rgba(148,163,184,0.25); border-radius:10px; padding:10px 12px; outline:none; width:100%; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .btn { appearance:none; border:none; border-radius:10px; padding:10px 14px; color:white; cursor:pointer; transition: all .2s ease; font-weight:600; letter-spacing:.2px; font-size:13px; }
    .btn-primary { background:linear-gradient(180deg, #60a5fa, #3b82f6); box-shadow: 0 6px 18px rgba(59,130,246,0.35); }
    .btn-primary:hover { filter:brightness(1.06); transform: translateY(-1px); }
    .btn-accent { background:linear-gradient(180deg, #34d399, #22c55e); box-shadow: 0 6px 18px rgba(16,185,129,0.35); }
    .btn-danger { background:linear-gradient(180deg, #f87171, #ef4444); box-shadow: 0 6px 18px rgba(239,68,68,0.35); }
    .btn-warning { background:linear-gradient(180deg, #fbbf24, #f59e0b); box-shadow: 0 6px 18px rgba(245,158,11,0.35); }
    .muted { color:var(--muted); font-size:13px; }
    .pill { display:inline-flex; align-items:center; gap:6px; border:1px solid rgba(148,163,184,0.25); background:#0b1220; padding:6px 10px; border-radius:999px; font-size:12px; }
    code { background:#0b1220; border:1px solid rgba(148,163,184,0.25); padding:2px 6px; border-radius:6px; font-size:11px; }
    .list { max-height:300px; overflow:auto; border:1px solid rgba(148,163,184,0.15); border-radius:10px; background:#0b1220; }
    .list pre { margin:0; padding:10px; white-space:pre-wrap; word-wrap:break-word; font-size:11px; }
    .stack { display:flex; flex-direction:column; gap:8px; }
    .status-badge { display:inline-block; padding:4px 10px; border-radius:12px; font-size:11px; font-weight:600; }
    .status-PENDING { background:#f59e0b; color:#0f172a; }
    .status-CONFIRMED { background:#22c55e; color:#0f172a; }
    .status-CANCELLED { background:#ef4444; color:white; }
    .saga-flow { display:flex; align-items:center; gap:12px; padding:12px; background:#0b1220; border-radius:10px; margin:8px 0; }
    .saga-step { flex:1; text-align:center; padding:8px; border-radius:8px; background:rgba(148,163,184,0.1); }
    .saga-step.active { background:var(--primary); color:white; }
    .saga-step.completed { background:var(--accent); color:white; }
    .saga-step.failed { background:var(--danger); color:white; }
    .saga-arrow { color:var(--muted); font-size:18px; }
    .stats-table { width:100%; border-collapse:collapse; font-size:12px; }
    .stats-table th, .stats-table td { padding:8px; text-align:left; border-bottom:1px solid rgba(148,163,184,0.15); }
    .stats-table th { background:rgba(148,163,184,0.1); font-weight:600; }
    .stats-bar { height:20px; background:var(--primary); border-radius:4px; transition:width 0.3s; }
    .log-entry { padding:6px 10px; margin:4px 0; border-left:3px solid var(--primary); background:rgba(59,130,246,0.1); border-radius:4px; font-size:11px; font-family:monospace; }
    .log-entry.error { border-color:var(--danger); background:rgba(239,68,68,0.1); }
    .log-entry.success { border-color:var(--accent); background:rgba(34,197,94,0.1); }
    .log-entry.warning { border-color:var(--warning); background:rgba(245,158,11,0.1); }
  </style>
  <script>
    let token = localStorage.getItem('jwt') || '';
    let currentRequestId = null;
    let sagaLogs = [];

    function setStatus(msg, ok=true) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.style.color = ok ? '#22c55e' : '#ef4444';
    }

    function authHeaders() {
      return token ? { 'Authorization': 'Bearer ' + token } : {};
    }

    function addLog(message, type='info') {
      sagaLogs.unshift({time: new Date().toLocaleTimeString(), message, type});
      const logContainer = document.getElementById('saga-logs');
      if (logContainer) {
        logContainer.innerHTML = sagaLogs.slice(0, 20).map(log => 
          `<div class="log-entry ${log.type}">[${log.time}] ${log.message}</div>`
        ).join('');
      }
    }

    function updateSagaFlow(status) {
      const steps = ['PENDING', 'CONFIRMED'];
      const container = document.getElementById('saga-flow');
      if (!container) return;
      
      container.innerHTML = steps.map((step, i) => {
        let cls = '';
        if (step === 'PENDING' && (status === 'PENDING' || status === 'CONFIRMED')) {
          cls = status === 'PENDING' ? 'active' : 'completed';
        } else if (step === 'CONFIRMED' && status === 'CONFIRMED') {
          cls = 'completed';
        } else if (status === 'CANCELLED') {
          cls = step === 'PENDING' ? 'failed' : '';
        }
        
        return `
          ${i > 0 ? '<span class="saga-arrow">‚Üí</span>' : ''}
          <div class="saga-step ${cls}">${step}</div>
        `;
      }).join('') + 
      (status === 'CANCELLED' ? '<span class="saga-arrow">‚Üí</span><div class="saga-step failed">CANCELLED</div>' : '');
    }

    async function registerUser() {
      const username = document.getElementById('reg-username').value.trim();
      const password = document.getElementById('reg-password').value;
      const res = await fetch('/api/user/register', {
        method: 'POST', headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ username, password })
      });
      if (!res.ok) { setStatus('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å (' + res.status + ')', false); return; }
      const data = await res.json();
      token = data.token; localStorage.setItem('jwt', token);
      setStatus('–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω –≤—Ö–æ–¥');
      showToken();
      addLog('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω', 'success');
    }

    async function loginUser() {
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      const res = await fetch('/api/user/auth', {
        method: 'POST', headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ username, password })
      });
      if (!res.ok) { setStatus('–í—Ö–æ–¥ –Ω–µ —É–¥–∞–ª—Å—è (' + res.status + ')', false); return; }
      const data = await res.json();
      token = data.token; localStorage.setItem('jwt', token);
      setStatus('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
      showToken();
      addLog('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω', 'success');
    }

    function logout() {
      token = ''; localStorage.removeItem('jwt');
      document.getElementById('jwt').textContent='‚Äî';
      setStatus('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
      addLog('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'warning');
    }

    function showToken() {
      document.getElementById('jwt').textContent = token ? token.substring(0,32) + '‚Ä¶' : '‚Äî';
    }

    function generateRequestId() {
      return 'req-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    }

    function formatJSON(text) {
      try {
        const json = JSON.parse(text);
        return JSON.stringify(json, null, 2);
      } catch {
        return text;
      }
    }

    async function listHotels() {
      const res = await fetch('/api/hotels', { headers: { ...authHeaders() } });
      const out = document.getElementById('hotels-out');
      const text = await res.text();
      out.textContent = formatJSON(text);
      setStatus(res.ok ? '–ü–æ–ª—É—á–µ–Ω—ã –æ—Ç–µ–ª–∏' : '–û—à–∏–±–∫–∞ –æ—Ç–µ–ª–µ–π (' + res.status + ')', res.ok);
    }

    async function listRooms() {
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;
      const url = `/api/rooms?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
      const res = await fetch(url, { headers: { ...authHeaders() } });
      const out = document.getElementById('rooms-out');
      const text = await res.text();
      out.textContent = formatJSON(text);
      setStatus(res.ok ? '–ü–æ–ª—É—á–µ–Ω—ã –∫–æ–º–Ω–∞—Ç—ã' : '–û—à–∏–±–∫–∞ –∫–æ–º–Ω–∞—Ç (' + res.status + ')', res.ok);
    }

    async function listRecommended() {
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;
      const url = `/api/rooms/recommend?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
      addLog(`–ó–∞–ø—Ä–æ—Å —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç (${start} - ${end})`, 'info');
      const res = await fetch(url, { headers: { ...authHeaders() } });
      const out = document.getElementById('rooms-out');
      const text = await res.text();
      out.textContent = formatJSON(text);
      if (res.ok) {
        try {
          const rooms = JSON.parse(text);
          addLog(`–ù–∞–π–¥–µ–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç: ${rooms.length} (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ times_booked ASC)`, 'success');
          if (rooms.length > 0) {
            rooms.forEach(r => {
              addLog(`–ö–æ–º–Ω–∞—Ç–∞ #${r.id} (–Ω–æ–º–µ—Ä ${r.number}): times_booked=${r.timesBooked || 0}`, 'info');
            });
          }
        } catch(e) {}
      }
      setStatus(res.ok ? '–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã (–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ times_booked)' : '–û—à–∏–±–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π (' + res.status + ')', res.ok);
    }

    async function loadStats() {
      const res = await fetch('/api/rooms/stats', { headers: { ...authHeaders() } });
      const out = document.getElementById('stats-out');
      const text = await res.text();
      if (res.ok) {
        try {
          const stats = JSON.parse(text);
          let html = '<table class="stats-table"><thead><tr><th>ID</th><th>–ù–æ–º–µ—Ä</th><th>–û—Ç–µ–ª—å</th><th>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</th><th>–ê–∫—Ç–∏–≤–Ω—ã—Ö</th><th>–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å</th></tr></thead><tbody>';
          const maxBooked = Math.max(...stats.map(s => s.timesBooked || 0), 1);
          stats.forEach(s => {
            const pct = maxBooked > 0 ? ((s.timesBooked || 0) / maxBooked * 100).toFixed(0) : 0;
            html += `<tr>
              <td>${s.roomId}</td>
              <td>${s.roomNumber}</td>
              <td>${s.hotelName || '-'}</td>
              <td><strong>${s.timesBooked || 0}</strong></td>
              <td>${s.activeHolds || 0}</td>
              <td><div style="display:flex;align-items:center;gap:8px;">
                <div style="flex:1;background:rgba(148,163,184,0.2);border-radius:4px;height:20px;overflow:hidden;">
                  <div class="stats-bar" style="width:${pct}%"></div>
                </div>
                <span>${pct}%</span>
              </div></td>
            </tr>`;
          });
          html += '</tbody></table>';
          out.innerHTML = html;
          addLog(`–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞: ${stats.length} –Ω–æ–º–µ—Ä–æ–≤`, 'success');
        } catch(e) {
          out.textContent = formatJSON(text);
        }
      } else {
        out.textContent = formatJSON(text);
      }
      setStatus(res.ok ? '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞' : '–û—à–∏–±–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (' + res.status + ')', res.ok);
    }

    async function createBooking() {
      const start = document.getElementById('b-start').value;
      const end = document.getElementById('b-end').value;
      const auto = document.getElementById('b-auto').checked;
      const roomId = document.getElementById('b-roomId').value.trim();
      const reqId = generateRequestId();
      currentRequestId = reqId;
      
      addLog(`=== –ù–∞—á–∞–ª–æ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ===`, 'info');
      addLog(`RequestId: ${reqId}`, 'info');
      addLog(`–î–∞—Ç—ã: ${start} - ${end}`, 'info');
      addLog(`–ê–≤—Ç–æ–≤—ã–±–æ—Ä: ${auto}`, 'info');
      
      updateSagaFlow('PENDING');
      
      const body = { 
        startDate: start, 
        endDate: end, 
        autoSelect: auto,
        requestId: reqId
      };
      if (!auto && roomId) body.roomId = Number(roomId);
      
      addLog(`–®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ PENDING –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...`, 'info');
      
      const res = await fetch('/api/booking', {
        method:'POST', headers: { 'Content-Type':'application/json', ...authHeaders() },
        body: JSON.stringify(body)
      });
      
      const out = document.getElementById('booking-out');
      const text = await res.text();
      out.textContent = formatJSON(text);
      
      if (res.ok) {
        try {
          const booking = JSON.parse(text);
          addLog(`‚úì PENDING —Å–æ–∑–¥–∞–Ω: bookingId=${booking.id}, roomId=${booking.roomId}`, 'success');
          addLog(`–®–∞–≥ 2: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤ Hotel Service...`, 'info');
          updateSagaFlow(booking.status);
          
          // –ñ–¥—ë–º –Ω–µ–º–Ω–æ–≥–æ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
          setTimeout(async () => {
            try {
              const checkRes = await fetch(`/api/booking/${booking.id}`, { headers: { ...authHeaders() } });
              if (checkRes.ok) {
                const updated = JSON.parse(await checkRes.text());
                updateSagaFlow(updated.status);
                if (updated.status === 'CONFIRMED') {
                  addLog(`‚úì CONFIRMED: –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ`, 'success');
                  addLog(`–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è`, 'success');
                } else if (updated.status === 'CANCELLED') {
                  addLog(`‚úó CANCELLED: –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è`, 'error');
                  addLog(`–í—Ä–µ–º–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–Ω—è—Ç–∞ —á–µ—Ä–µ–∑ POST /api/rooms/${booking.roomId}/release`, 'warning');
                }
              }
            } catch(e) {}
            setTimeout(() => myBookings(), 300);
          }, 1000);
        } catch(e) {
          addLog(`–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ (–æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω)`, 'success');
          setTimeout(() => myBookings(), 500);
        }
      } else {
        addLog(`‚úó –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${res.status}`, 'error');
        if (res.status === 409) {
          addLog(`–ö–æ–Ω—Ñ–ª–∏–∫—Ç: –Ω–æ–º–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞`, 'error');
          updateSagaFlow('CANCELLED');
        }
      }
      
      setStatus(res.ok ? '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ' : '–ö–æ–Ω—Ñ–ª–∏–∫—Ç/–æ—à–∏–±–∫–∞ (' + res.status + ')', res.ok);
    }

    async function testIdempotency() {
      if (!currentRequestId) {
        setStatus('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ', false);
        return;
      }
      addLog(`=== –¢–µ—Å—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ ===`, 'info');
      addLog(`–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å —Ç–µ–º –∂–µ requestId: ${currentRequestId}`, 'info');
      
      const start = document.getElementById('b-start').value;
      const end = document.getElementById('b-end').value;
      const auto = document.getElementById('b-auto').checked;
      const roomId = document.getElementById('b-roomId').value.trim();
      
      const body = { 
        startDate: start, 
        endDate: end, 
        autoSelect: auto,
        requestId: currentRequestId
      };
      if (!auto && roomId) body.roomId = Number(roomId);
      
      const res = await fetch('/api/booking', {
        method:'POST', headers: { 'Content-Type':'application/json', ...authHeaders() },
        body: JSON.stringify(body)
      });
      
      const text = await res.text();
      if (res.ok) {
        try {
          const booking = JSON.parse(text);
          addLog(`‚úì –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ —Ç–æ –∂–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (ID=${booking.id})`, 'success');
          addLog(`–î—É–±–ª–∏–∫–∞—Ç—ã –Ω–µ —Å–æ–∑–¥–∞–Ω—ã`, 'success');
        } catch(e) {}
      }
      document.getElementById('booking-out').textContent = formatJSON(text);
    }

    async function myBookings() {
      const res = await fetch('/api/bookings?size=10', { headers: { ...authHeaders() } });
      const out = document.getElementById('mybookings-out');
      const text = await res.text();
      if (res.ok) {
        try {
          const data = JSON.parse(text);
          const bookings = data.content || data;
          let html = '<table class="stats-table"><thead><tr><th>ID</th><th>–ö–æ–º–Ω–∞—Ç–∞</th><th>–î–∞—Ç—ã</th><th>–°—Ç–∞—Ç—É—Å</th><th>RequestId</th></tr></thead><tbody>';
          bookings.forEach(b => {
            html += `<tr>
              <td>${b.id}</td>
              <td>${b.roomId}</td>
              <td>${b.startDate} - ${b.endDate}</td>
              <td><span class="status-badge status-${b.status}">${b.status}</span></td>
              <td><code>${b.requestId ? b.requestId.substring(0, 16) + '‚Ä¶' : '-'}</code></td>
            </tr>`;
          });
          html += '</tbody></table>';
          out.innerHTML = html;
        } catch(e) {
          out.textContent = formatJSON(text);
        }
      } else {
        out.textContent = formatJSON(text);
      }
      setStatus(res.ok ? '–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—É—á–µ–Ω—ã' : '–û—à–∏–±–∫–∞ (' + res.status + ')', res.ok);
    }

    async function cancelBooking() {
      const id = document.getElementById('cancel-id').value.trim();
      if (!id) { setStatus('–£–∫–∞–∂–∏—Ç–µ ID –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è', false); return; }
      addLog(`–û—Ç–º–µ–Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ID=${id}`, 'warning');
      const res = await fetch('/api/booking/' + encodeURIComponent(id), { method:'DELETE', headers: { ...authHeaders() } });
      setStatus(res.status === 204 ? '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ' : '–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã (' + res.status + ')', res.status === 204);
      if (res.status === 204) {
        addLog(`–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ`, 'warning');
        setTimeout(() => myBookings(), 300);
      }
    }

    function initDefaults() {
      showToken();
      const today = new Date();
      const plus2 = new Date(today.getTime() + 2*24*3600*1000);
      const fmt = d => d.toISOString().slice(0,10);
      document.getElementById('start').value = fmt(today);
      document.getElementById('end').value = fmt(plus2);
      document.getElementById('b-start').value = fmt(today);
      document.getElementById('b-end').value = fmt(plus2);
      addLog('–¢–µ—Å—Ç–æ–≤—ã–π —Å—Ç–µ–Ω–¥ –≥–æ—Ç–æ–≤', 'success');
      addLog('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ù–∞—á–Ω–∏—Ç–µ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'info');
    }

    window.addEventListener('DOMContentLoaded', initDefaults);
  </script>
</head>
<body>
  <header>
    <h1 style="margin:0 0 8px; font-size:24px;">üß™ –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ç–µ–Ω–¥ Microservices</h1>
    <div class="pill">API Gateway ‚Ä¢ <span id="status" class="muted">–ì–æ—Ç–æ–≤</span></div>
    <div class="muted" style="margin-top:8px">JWT: <code id="jwt">‚Äî</code></div>
  </header>

  <div class="container">
    <section class="card">
      <h2>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
      <div class="stack">
        <input id="reg-username" type="text" placeholder="–õ–æ–≥–∏–Ω" value="user" />
        <input id="reg-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" value="user" />
        <button class="btn btn-accent" onclick="registerUser()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –≤–æ–π—Ç–∏</button>
      </div>
      <div class="stack" style="margin-top:12px">
        <input id="login-username" type="text" placeholder="–õ–æ–≥–∏–Ω" value="user" />
        <input id="login-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" value="user" />
        <div class="row">
          <button class="btn btn-primary" onclick="loginUser()">–í–æ–π—Ç–∏</button>
          <button class="btn" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>üè® –û—Ç–µ–ª–∏</h2>
      <div class="row"><button class="btn btn-primary" onclick="listHotels()">–°–ø–∏—Å–æ–∫ –æ—Ç–µ–ª–µ–π</button></div>
      <div class="list"><pre id="hotels-out"></pre></div>
    </section>

    <section class="card">
      <h2>üõèÔ∏è –ö–æ–º–Ω–∞—Ç—ã</h2>
      <div class="grid-2">
        <div class="stack"><label>–ù–∞—á–∞–ª–æ</label><input id="start" type="date" /></div>
        <div class="stack"><label>–ö–æ–Ω–µ—Ü</label><input id="end" type="date" /></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn btn-primary" onclick="listRooms()">–°–≤–æ–±–æ–¥–Ω—ã–µ</button>
        <button class="btn btn-warning" onclick="listRecommended()">–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ ‚ö°</button>
      </div>
      <h3>üìä –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏:</h3>
      <div class="muted" style="font-size:11px; line-height:1.5;">
        –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é <code>times_booked</code> 
        (–ø—Ä–∏ —Ä–∞–≤–µ–Ω—Å—Ç–≤–µ ‚Äî –ø–æ <code>id</code>). –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ 
        –±–µ–∑ ¬´–ø—Ä–æ—Å—Ç–æ—è¬ª –Ω–æ–º–µ—Ä–æ–≤.
      </div>
      <div class="list"><pre id="rooms-out"></pre></div>
    </section>

    <section class="card full">
      <h2>üìÖ –°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (Saga Pattern)</h2>
      <div class="grid-2">
        <div class="stack"><label>–ù–∞—á–∞–ª–æ</label><input id="b-start" type="date" /></div>
        <div class="stack"><label>–ö–æ–Ω–µ—Ü</label><input id="b-end" type="date" /></div>
      </div>
      <div class="row" style="margin-top:8px">
        <label class="row" style="gap:6px"><input id="b-auto" type="checkbox" checked /> –ê–≤—Ç–æ–≤—ã–±–æ—Ä (–∞–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏)</label>
        <input id="b-roomId" type="number" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã (–µ—Å–ª–∏ –±–µ–∑ –∞–≤—Ç–æ)" style="max-width:220px" />
        <button class="btn btn-accent" onclick="createBooking()">–°–æ–∑–¥–∞—Ç—å</button>
        <button class="btn btn-warning" onclick="testIdempotency()">–¢–µ—Å—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏</button>
      </div>
      <h3>üîÑ Saga Flow:</h3>
      <div id="saga-flow" class="saga-flow">
        <div class="saga-step">PENDING</div>
        <span class="saga-arrow">‚Üí</span>
        <div class="saga-step">CONFIRMED</div>
      </div>
      <div class="muted" style="font-size:11px; margin-top:8px; line-height:1.5;">
        <strong>–î–≤—É—Ö—à–∞–≥–æ–≤–∞—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å:</strong><br/>
        1. PENDING: –ª–æ–∫–∞–ª—å–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤ Booking Service<br/>
        2. CONFIRMED: –≤—ã–∑–æ–≤ Hotel Service –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏<br/>
        3. –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Üí CANCELLED + –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è (release)
      </div>
      <div class="list"><pre id="booking-out"></pre></div>
    </section>

    <section class="card full">
      <h2>üìã –õ–æ–≥–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ (Saga + –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)</h2>
      <div id="saga-logs" class="list" style="max-height:200px;"></div>
    </section>

    <section class="card">
      <h2>üìä –ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
      <div class="row"><button class="btn btn-primary" onclick="myBookings()">–û–±–Ω–æ–≤–∏—Ç—å</button></div>
      <div id="mybookings-out" class="list"></div>
    </section>

    <section class="card">
      <h2>‚ùå –û—Ç–º–µ–Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
      <div class="row">
        <input id="cancel-id" type="number" placeholder="ID –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è" style="max-width:220px" />
        <button class="btn btn-danger" onclick="cancelBooking()">–û—Ç–º–µ–Ω–∏—Ç—å</button>
      </div>
    </section>

    <section class="card full">
      <h2>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–æ–º–µ—Ä–æ–≤</h2>
      <div class="muted" style="font-size:11px; margin-bottom:8px;">
        –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –∫–∞–∂–¥–æ–≥–æ –Ω–æ–º–µ—Ä–∞ (<code>times_booked</code>). 
        –ê–ª–≥–æ—Ä–∏—Ç–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏.
      </div>
      <div class="row"><button class="btn btn-primary" onclick="loadStats()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button></div>
      <div id="stats-out" class="list"></div>
    </section>
  </div>
</body>
</html>